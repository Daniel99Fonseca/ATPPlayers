use("atp");
db.createCollection("Mongo-Clean-Cleaned")

db["atpplayers"].aggregate([
  {
    $group: {
      _id: {
        PlayerName: "$PlayerName",
        Tournament: "$Tournament",
        Date: "$Date",
        Oponent: "$Oponent"
      },
      doc: { $first: "$$ROOT" }  // mantém o primeiro documento
    }
  },
  { $replaceRoot: { newRoot: "$doc" } },
  { $out: "Mongo-Clean-NoDups" } // escreve em coleção temporária
])

db["Mongo-Clean-NoDups"].updateMany(
  {},
  [
    {
      $set: {
        Date: {
          $dateFromString: {
            dateString: {
              $substrCP: ["$Date", 0, 10]  // extrai só "YYYY.MM.DD"
            },
            format: "%Y.%m.%d"
          }
        }
      }
    }
  ]
)

db["Mongo-Clean-NoDups"].updateMany(
  {},
  [
    {
      $set: {
        Prize: {
          $cond: [
            { $or: [ { $eq: ["$Prize", ""] }, { $eq: ["$Prize", null] } ] }, // se vazio ou null
            0, // retorna 0
            {
              $toInt: {
                $replaceAll: {
                  input: { $substrCP: ["$Prize", 1, { $strLenCP: "$Prize" }] }, // remove símbolo de $
                  find: ",",
                  replacement: ""
                }
              }
            }
          ]
        }
      }
    }
  ]
)

db["Mongo-Clean-NoDups"].aggregate([
  { $match: {} },
  { $out: "Mongo-Clean-Cleaned" }
])