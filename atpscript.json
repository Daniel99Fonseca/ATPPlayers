use("atp");
db.createCollection("Mongo-Clean-Cleaned")

db["atpplayers"].aggregate([
  {
    $group: {
      _id: {
        PlayerName: "$PlayerName",
        Tournament: "$Tournament",
        Date: "$Date",
        Oponent: "$Oponent"
      },
      doc: { $first: "$$ROOT" } 
    }
  },
  { $replaceRoot: { newRoot: "$doc" } },
  { $out: "Mongo-Clean-NoDups" } 
])

db["Mongo-Clean-NoDups"].updateMany(
  {},
  [
    {
      $set: {
        Date: {
          $dateFromString: {
            dateString: {
              $substrCP: ["$Date", 0, 10] 
            },
            format: "%Y.%m.%d"
          }
        }
      }
    }
  ]
)

db["Mongo-Clean-NoDups"].updateMany(
  {},
  [
    {
      $set: {
        Prize: {
          $cond: [
            { $or: [ { $eq: ["$Prize", ""] }, { $eq: ["$Prize", null] } ] },
            0,
            {
              $toInt: {
                $replaceAll: {
                  input: {
                    $trim: {
                      input: {
                        $substrCP: ["$Prize", 1, { $subtract: [{ $strLenCP: "$Prize" }, 1] }]
                      }
                    }
                  },
                  find: ",",
                  replacement: ""
                }
              }
            }
          ]
        }
      }
    }
  ]
)

db["Mongo-Clean-NoDups"].aggregate([
  { $match: {} },
  { $out: "Mongo-Clean-Cleaned" }
])